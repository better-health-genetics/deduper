
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BHG DeDuper</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- This script block receives the appMode from the backend -->
  <script>
    var appMode = '<?= appMode ?>';
  </script>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.1.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.1.1/",
    "react/": "https://aistudiocdn.com/react@^19.1.1/"
  }
}
</script>
</head>
<body class="bg-gray-800">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;

    // --- ENVIRONMENT-AWARE SERVER CONNECTOR ---
    const server = (() => {
      if (window.google && window.google.script) {
        return {
          run(functionName, ...args) {
            return new Promise((resolve, reject) => {
              google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                [functionName](...args);
            });
          }
        };
      } else {
        console.warn("Running in local mock mode.");
        const MOCK_LATENCY = 800;
        const mockDatabase = {
          getAdminOverviewData: () => ([
            { id: '1', name: 'RCC (DEV)', percentage: 12, totalChecked: 58, totalDuplicates: 7 },
            { id: '2', name: 'TBM (DEV)', percentage: 28, totalChecked: 112, totalDuplicates: 31 },
            { id: '3', name: 'Wave', percentage: 5, totalChecked: 80, totalDuplicates: 4 },
          ]),
          processRecord: (formData) => {
             const isDuplicate = Math.random() > 0.7;
             if (isDuplicate) {
                 return { success: false, message: '2 potential duplicate(s) found in Master.', duplicatesFound: 2 };
             }
             return { success: true, message: 'Record added. No duplicates found in Master.' };
          }
        };
        return {
          run(functionName, ...args) {
            // In source sheets, the UI calls `processRecord`, which is the client-side bridge.
            const effectiveFunctionName = (appMode === 'entry' && functionName === 'processSourceSheetRecordForLibrary') 
              ? 'processRecord' 
              : functionName;

            return new Promise((resolve, reject) => {
              setTimeout(() => {
                if (mockDatabase[effectiveFunctionName]) {
                  resolve(mockDatabase[effectiveFunctionName](...args));
                } else {
                  reject(new Error(`Mock function ${effectiveFunctionName} not found.`));
                }
              }, MOCK_LATENCY);
            });
          }
        };
      }
    })();

    // --- SHARED COMPONENTS ---
    const Spinner = () => (<svg className="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>);
    const Message = ({ text, type }) => {
      if (!text) return null;
      const styles = {
        Success: 'bg-green-900/50 text-green-300',
        Error: 'bg-red-900/50 text-red-300',
        Warning: 'bg-orange-800/70 text-orange-300',
      };
      return <div className={`text-sm font-medium text-center p-1.5 rounded-md w-full ${styles[type]}`} role="alert">{text}</div>;
    };

    // ========================================================================
    //                         ADMIN DASHBOARD APP
    // ========================================================================
    const AdminDashboard = () => {
      const [stats, setStats] = useState([]);
      const [isLoading, setIsLoading] = useState(true);
      const [error, setError] = useState(null);

      const fetchStats = useCallback(async () => {
        setIsLoading(true);
        setError(null);
        try {
          const data = await server.run('getAdminOverviewData');
          setStats(data);
        } catch (err) {
          setError('Failed to load overview data.');
          console.error(err);
        } finally {
          setIsLoading(false);
        }
      }, []);

      useEffect(() => {
        fetchStats();
      }, [fetchStats]);

      const getHealthColor = (percentage) => {
        if (percentage <= 15) return 'text-green-400';
        if (percentage < 30) return 'text-yellow-400';
        return 'text-red-400';
      };

      return (
        <div className="p-4 space-y-4">
          {isLoading && <div className="flex justify-center items-center h-48"><Spinner /></div>}
          {error && <div className="text-red-400 text-center">{error}</div>}
          {!isLoading && !error && stats.map(stat => (
            <div key={stat.id} className="bg-gray-800 p-3 rounded-lg border border-gray-700">
              <div className="flex justify-between items-center">
                <p className="font-semibold text-gray-200 truncate pr-2">{stat.name}</p>
                <p className={`text-2xl font-bold ${getHealthColor(stat.percentage)}`}>{stat.percentage}%</p>
              </div>
              <p className="text-xs text-gray-400 mt-1">{stat.totalDuplicates} duplicates / {stat.totalChecked} checked this week</p>
            </div>
          ))}
        </div>
      );
    };


    // ========================================================================
    //                         SOURCE SHEET ENTRY APP
    // ========================================================================
    const DeDuperForm = () => {
      const [isSubmitting, setIsSubmitting] = useState(false);
      const [message, setMessage] = useState({ text: '', type: 'None' });
      
      // Auto-clear message
      useEffect(() => {
        if (message.text) {
          const timer = setTimeout(() => setMessage({ text: '', type: 'None' }), 7000);
          return () => clearTimeout(timer);
        }
      }, [message]);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setIsSubmitting(true);
        setMessage({ text: '', type: 'None' });

        const formData = {
          firstName: e.target.firstName.value,
          lastName: e.target.lastName.value,
          dob: e.target.dob.value,
        };

        try {
          // This function name matches the one in `SourceSheetScript.js`
          const response = await server.run('processRecord', formData);
          if (response.success) {
            setMessage({ text: response.message, type: 'Success' });
            e.target.reset();
          } else {
            setMessage({ text: response.message, type: response.duplicatesFound > 0 ? 'Warning' : 'Error' });
          }
        } catch (err) {
          setMessage({ text: err.message || 'An unexpected error occurred.', type: 'Error' });
        } finally {
          setIsSubmitting(false);
        }
      };

      return (
        <form onSubmit={handleSubmit} className="p-4 space-y-3">
           <div className="h-10 flex items-center justify-center">
              <Message text={message.text} type={message.type} />
           </div>
          <div className="grid grid-cols-2 gap-3">
            <div>
              <label htmlFor="firstName" className="block text-sm font-medium text-gray-300 mb-1">First Name</label>
              <input type="text" id="firstName" required className="w-full bg-gray-700 border border-gray-600 rounded-md py-1.5 px-3 text-gray-100 focus:outline-none focus:ring-2 focus:ring-cyan-500" />
            </div>
            <div>
              <label htmlFor="lastName" className="block text-sm font-medium text-gray-300 mb-1">Last Name</label>
              <input type="text" id="lastName" required className="w-full bg-gray-700 border border-gray-600 rounded-md py-1.5 px-3 text-gray-100 focus:outline-none focus:ring-2 focus:ring-cyan-500" />
            </div>
          </div>
          <div>
            <label htmlFor="dob" className="block text-sm font-medium text-gray-300 mb-1">Date of Birth</label>
            <input type="date" id="dob" required className="w-full bg-gray-700 border border-gray-600 rounded-md py-1.5 px-3 text-gray-100 focus:outline-none focus:ring-2 focus:ring-cyan-500" />
          </div>
          <button type="submit" disabled={isSubmitting} className="w-full flex justify-center items-center py-2 px-4 border border-transparent rounded-md text-sm font-medium text-white bg-cyan-600 hover:bg-cyan-700 focus:outline-none focus:ring-2 focus:ring-cyan-500 disabled:bg-gray-500 disabled:cursor-not-allowed">
            {isSubmitting ? <Spinner /> : 'Add & Check Record'}
          </button>
        </form>
      );
    };


    // --- MAIN APP CONTAINER & ROUTER ---
    const App = () => {
      let view;
      let title;
      
      // Use the 'appMode' variable from the backend to decide which UI to show
      if (appMode === 'admin') {
        view = <AdminDashboard />;
        title = 'Admin Overview';
      } else { // Default to 'entry'
        view = <DeDuperForm />;
        title = 'BHG DeDuper';
      }
      
      return (
        <div className="min-h-screen bg-gray-900 text-gray-100 font-sans">
          <header className="p-3 bg-gray-700 border-b border-gray-600">
            <h1 className="text-lg font-bold text-center text-cyan-400">{title}</h1>
          </header>
          <main>
            {view}
          </main>
        </div>
      );
    };
    
    // --- RENDER THE APP ---
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

  </script>
</body>
</html>
