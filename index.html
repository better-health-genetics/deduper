<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Duplicate Checker</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React & ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <!-- Babel for JSX Transpilation -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.1.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.1.1/",
    "react/": "https://aistudiocdn.com/react@^19.1.1/"
  }
}
</script>
</head>
<body class="bg-gray-800">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;

    // --- ENVIRONMENT-AWARE SERVER CONNECTOR ---
    // This object intelligently switches between the real Google Apps Script
    // backend and a local mock server for development.
    const server = (() => {
      // Check if we are in the Google Apps Script environment
      if (window.google && window.google.script) {
        console.log("Running in Google Apps Script environment.");
        return {
          run(functionName, ...args) {
            return new Promise((resolve, reject) => {
              google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                [functionName](...args);
            });
          }
        };
      } else {
        // --- MOCK SERVER for local development ---
        // This part runs only when you open the HTML file directly in your browser.
        console.warn("Running in local mock mode. 'google.script.run' not found.");
        const MOCK_LATENCY = 800;
        
        const mockDatabase = {
          getDuplicateHealthData: () => {
            const totalChecked = Math.floor(Math.random() * 150) + 10;
            const totalDuplicates = Math.floor(Math.random() * (totalChecked * 0.45));
            const percentage = totalChecked > 0 ? Math.round((totalDuplicates / totalChecked) * 100) : 0;
            return { percentage, totalChecked, totalDuplicates };
          },
          addRecordAndCheckDuplicates: (formData) => {
            if (!formData.firstName || !formData.lastName || !formData.dob) {
              return { success: false, message: 'Error: All mandatory fields must be provided.' };
            }
            const isDuplicate = Math.random() > 0.6; // 40% chance of duplicate
            if (isDuplicate) {
              const numDupes = Math.floor(Math.random() * 4) + 1;
              return {
                success: false,
                message: `Record added to "Checker" tab. ${numDupes} duplicates found.`,
                duplicatesFound: numDupes,
              };
            } else {
              return { success: true, message: 'Record added to "Checker" tab. No duplicates found.' };
            }
          }
        };

        return {
          run(functionName, ...args) {
            console.log(`Mock server called: ${functionName}`, args);
            return new Promise((resolve, reject) => {
              setTimeout(() => {
                if (mockDatabase[functionName]) {
                  const result = mockDatabase[functionName](...args);
                  resolve(result);
                } else {
                  reject(new Error(`Mock function ${functionName} not found.`));
                }
              }, MOCK_LATENCY);
            });
          }
        };
      }
    })();


    // --- ENUMS & TYPES (defined inline) ---
    const MessageType = {
      Success: 'Success',
      Error: 'Error',
      Warning: 'Warning',
      None: 'None',
    };

    // --- COMPONENTS ---

    const Spinner = () => (
      <svg
        className="animate-spin h-5 w-5 text-white"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
      >
        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
    );

    const Message = ({ text, type, subtext }) => {
      if (!text) return null;

      const baseClasses = 'text-sm font-medium text-center p-1.5 rounded-md w-full';
      let typeClasses = '';

      switch (type) {
        case MessageType.Success:
          typeClasses = 'bg-green-900/50 text-green-300';
          break;
        case MessageType.Error:
          typeClasses = 'bg-red-900/50 text-red-300';
          break;
        case MessageType.Warning:
          typeClasses = 'bg-orange-800/70 text-orange-300';
          break;
        default:
          return null;
      }

      return (
        <div className={`${baseClasses} ${typeClasses}`} role="alert">
          <p>{text}</p>
          {subtext && <p className="text-red-400 font-bold mt-1">{subtext}</p>}
        </div>
      );
    };

    const DuplicateHealth = ({ data, isLoading }) => {
      const getHealthColor = (percentage) => {
        if (percentage <= 15) return 'text-green-400';
        if (percentage < 30) return 'text-yellow-400';
        return 'text-red-400';
      };
      const getHealthBarColor = (percentage) => {
        if (percentage <= 15) return 'bg-green-500';
        if (percentage < 30) return 'bg-yellow-500';
        return 'bg-red-500';
      };

      if (isLoading) {
        return (
          <div className="bg-gray-800 p-3 rounded-lg animate-pulse">
            <div className="h-4 bg-gray-700 rounded w-3/4 mb-2"></div>
            <div className="h-8 bg-gray-700 rounded w-1/4 mb-3"></div>
            <div className="h-2 bg-gray-700 rounded"></div>
          </div>
        );
      }

      if (!data) {
        return (
            <div className="bg-gray-800 p-3 rounded-lg text-center text-gray-400">
                No health data available.
            </div>
        );
      }

      const { percentage } = data;
      const colorClass = getHealthColor(percentage);
      const barColorClass = getHealthBarColor(percentage);
      
      return (
        <div className="bg-gray-800 p-3 rounded-lg border border-gray-700">
          <h2 className="text-lg font-semibold text-gray-200 mb-1">Duplicate Health</h2>
          <p className="text-xs text-gray-400 mb-2">Percentage of duplicates since previous Monday.</p>
          <div className="flex items-center gap-4">
            <p className={`text-4xl font-bold ${colorClass}`}>{percentage}%</p>
            <div className="w-full">
                <div className="flex justify-between text-xs text-gray-400 mb-1">
                    <span>{data.totalDuplicates} Duplicates</span>
                    <span>{data.totalChecked} Total</span>
                </div>
                <div className="w-full bg-gray-700 rounded-full h-2.5">
                    <div 
                        className={`${barColorClass} h-2.5 rounded-full transition-all duration-500 ease-out`} 
                        style={{ width: `${percentage}%` }}
                    ></div>
                </div>
            </div>
          </div>
        </div>
      );
    };

    const AddRecordForm = ({ onSubmit, isSubmitting }) => {
      const [firstName, setFirstName] = useState('');
      const [lastName, setLastName] = useState('');
      const [dob, setDob] = useState('');

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (isSubmitting || !firstName || !lastName || !dob) return;
        await onSubmit({ firstName, lastName, dob });
        setFirstName('');
        setLastName('');
        setDob('');
      };

      return (
        <form onSubmit={handleSubmit} className="space-y-3">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label htmlFor="firstName" className="block text-sm font-medium text-gray-300 mb-1">
                First Name
              </label>
              <input
                type="text"
                id="firstName"
                value={firstName}
                onChange={(e) => setFirstName(e.target.value)}
                required
                className="w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm py-1.5 px-3 text-gray-100 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500"
              />
            </div>
            <div>
              <label htmlFor="lastName" className="block text-sm font-medium text-gray-300 mb-1">
                Last Name
              </label>
              <input
                type="text"
                id="lastName"
                value={lastName}
                onChange={(e) => setLastName(e.target.value)}
                required
                className="w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm py-1.5 px-3 text-gray-100 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500"
              />
            </div>
          </div>
          <div>
            <label htmlFor="dob" className="block text-sm font-medium text-gray-300 mb-1">
              Date of Birth
            </label>
            <input
              type="date"
              id="dob"
              value={dob}
              onChange={(e) => setDob(e.target.value)}
              required
              className="w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm py-1.5 px-3 text-gray-100 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500"
            />
          </div>
          <button
            type="submit"
            disabled={isSubmitting}
            className="w-full flex justify-center items-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-cyan-600 hover:bg-cyan-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-cyan-500 disabled:bg-gray-500 disabled:cursor-not-allowed transition-colors"
          >
            {isSubmitting ? <Spinner /> : 'Add & Check Record'}
          </button>
        </form>
      );
    };

    // --- MAIN APP COMPONENT ---

    const App = () => {
      const [healthData, setHealthData] = useState(null);
      const [isLoadingHealth, setIsLoadingHealth] = useState(true);
      const [isSubmitting, setIsSubmitting] = useState(false);
      const [message, setMessage] = useState({ text: '', subtext: '', type: MessageType.None });

      const fetchHealthData = useCallback(async () => {
        setIsLoadingHealth(true);
        try {
          const data = await server.run('getDuplicateHealthData');
          if (data && data.error) throw new Error(data.error);
          setHealthData(data);
        } catch (error) {
          setMessage({ text: 'Failed to load health data.', type: MessageType.Error });
          console.error(error);
        } finally {
          setIsLoadingHealth(false);
        }
      }, []);

      useEffect(() => {
        fetchHealthData();
      }, [fetchHealthData]);
      
      // Auto-clear message after a delay
      useEffect(() => {
        if (message.text) {
          const timer = setTimeout(() => {
            setMessage({ text: '', subtext: '', type: MessageType.None });
          }, 7000); // 7 seconds
          
          return () => clearTimeout(timer); // Cleanup timer on re-render
        }
      }, [message]);

      const handleAddRecord = async (formData) => {
        setIsSubmitting(true);
        setMessage({ text: '', type: MessageType.None });
        try {
          const response = await server.run('addRecordAndCheckDuplicates', formData);
          
          if (response.success) {
            setMessage({ text: response.message, type: MessageType.Success });
            fetchHealthData(); 
          } else {
            if (response.duplicatesFound && response.duplicatesFound > 0) {
              setMessage({
                text: response.message,
                subtext: 'USE STAR LABS',
                type: MessageType.Warning,
              });
              // Force an immediate UI update for health data
              fetchHealthData();
            } else {
              setMessage({ text: response.message, type: MessageType.Error });
            }
          }
        } catch (error) {
          setMessage({ text: error.message || 'An unexpected error occurred.', type: MessageType.Error });
        } finally {
          setIsSubmitting(false);
        }
      };

      return (
        <div className="min-h-screen bg-gray-800 text-gray-100 p-2 font-sans">
          <div className="max-w-md mx-auto bg-gray-900 shadow-2xl rounded-lg overflow-hidden">
            <header className="p-4 bg-gray-700 border-b border-gray-600">
              <h1 className="text-xl font-bold text-center text-cyan-400">BHG DeDuper</h1>
            </header>
            <main className="p-4 space-y-4">
              <DuplicateHealth data={healthData} isLoading={isLoadingHealth} />
              <div className="h-10 flex items-center justify-center">
                 {message.text && <Message text={message.text} subtext={message.subtext} type={message.type} />}
              </div>
              <AddRecordForm onSubmit={handleAddRecord} isSubmitting={isSubmitting} />
            </main>
          </div>
        </div>
      );
    };

    // --- RENDER THE APP ---
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

  </script>
</body>
</html>