<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Duplicate Checker</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React & ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <!-- Babel for JSX Transpilation -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-800">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useMemo } = React;

    // --- ENVIRONMENT-AWARE SERVER CONNECTOR ---
    const server = (() => {
      if (window.google && window.google.script) {
        return {
          run(functionName, ...args) {
            return new Promise((resolve, reject) => {
              google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                [functionName](...args);
            });
          }
        };
      } else {
        // --- MOCK SERVER for local development ---
        console.warn("Running in local mock mode. 'google.script.run' not found.");
        const MOCK_LATENCY = 800;
        
        const mockDatabase = {
            getContext: () => {
                const contexts = [
                    { context: 'MASTER' },
                    { context: 'SOURCE', sourceId: '1QgLFeJiw8vuF849rGokWEDDsKyIpd5iKY9OY_SdrA4Q', sourceName: 'DEV RCC' },
                    { context: 'OTHER' },
                    { context: 'OTHER_NO_HEADERS' },
                ];
                return contexts[Math.floor(Math.random() * contexts.length)];
            },
            getAdminDashboardData: (startDate, endDate) => {
                 console.log("Mock fetching data for range:", startDate, "to", endDate);
                return [
                    { sourceId: '1', sourceName: 'MDS Unity (New)', percentage: 12, totalChecked: 89, totalDuplicates: 11 },
                    { sourceId: '2', sourceName: 'YEST', percentage: 28, totalChecked: 50, totalDuplicates: 14 },
                    { sourceId: '3', sourceName: 'RCC', percentage: 5, totalChecked: 120, totalDuplicates: 6 },
                    { sourceId: '4', sourceName: 'Wave', percentage: 45, totalChecked: 35, totalDuplicates: 16 },
                    { sourceId: '5', sourceName: 'TBM - ADL', percentage: 18, totalChecked: 77, totalDuplicates: 14 },
                ];
            },
            getGeminiHealthSummary: (stats) => {
                if (!stats || stats.length === 0) return "No stats provided for analysis.";
                const worst = stats.reduce((max, p) => p.percentage > max.percentage ? p : max, stats[0]);
                const best = stats.reduce((min, p) => p.percentage < min.percentage ? p : min, stats[0]);
                return `Overall data health shows some areas for improvement. The most significant challenge is with '${worst.sourceName}', which has a high ${worst.percentage}% duplicate rate. On a positive note, '${best.sourceName}' is performing very well with only ${best.percentage}% duplicates.`;
            },
            getSourceSheetHealthData: (sourceId) => {
                const totalChecked = Math.floor(Math.random() * 50) + 5;
                const totalDuplicates = Math.floor(Math.random() * (totalChecked * 0.35));
                const percentage = totalChecked > 0 ? Math.round((totalDuplicates / totalChecked) * 100) : 0;
                return { percentage, totalChecked, totalDuplicates };
            },
            getDuplicateHealthData: () => { // For 'OTHER' context
                const totalChecked = Math.floor(Math.random() * 150) + 10;
                const totalDuplicates = Math.floor(Math.random() * (totalChecked * 0.45));
                const percentage = totalChecked > 0 ? Math.round((totalDuplicates / totalChecked) * 100) : 0;
                return { percentage, totalChecked, totalDuplicates };
            },
            addRecordAndCheckDuplicates: (formData) => { // For 'OTHER' context
                if (!formData.firstName || !formData.lastName || !formData.dob) {
                    return { success: false, message: 'Error: All mandatory fields must be provided.' };
                }
                const isDuplicate = Math.random() > 0.6;
                if (isDuplicate) {
                    const numDupes = Math.floor(Math.random() * 4) + 1;
                    return {
                        success: false,
                        message: `Record added to "Checker" tab. ${numDupes} duplicates found.`,
                        duplicatesFound: numDupes,
                    };
                } else {
                    return { success: true, message: 'Record added to "Checker" tab. No duplicates found.' };
                }
            },
            addRecordToSourceSheet: (formData) => { // For 'SOURCE' context
                return { success: true, message: 'Record added to sheet. Syncing to Master...' };
            }
        };

        return {
          run(functionName, ...args) {
            console.log(`Mock server called: ${functionName}`, args);
            return new Promise((resolve, reject) => {
              setTimeout(() => {
                if (mockDatabase[functionName]) {
                  const result = mockDatabase[functionName](...args);
                  resolve(result);
                } else {
                  reject(new Error(`Mock function ${functionName} not found.`));
                }
              }, MOCK_LATENCY);
            });
          }
        };
      }
    })();

    // --- ENUMS ---
    const MessageType = {
      Success: 'Success',
      Error: 'Error',
      Warning: 'Warning',
      None: 'None',
    };

    // --- SHARED COMPONENTS ---

    const Spinner = () => (
      <svg className="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
    );

    const Message = ({ text, type, subtext }) => {
      if (!text) return null;
      const baseClasses = 'text-sm font-medium text-center p-1.5 rounded-md w-full';
      let typeClasses = '';
      switch (type) {
        case MessageType.Success: typeClasses = 'bg-green-900/50 text-green-300'; break;
        case MessageType.Error: typeClasses = 'bg-red-900/50 text-red-300'; break;
        case MessageType.Warning: typeClasses = 'bg-orange-800/70 text-orange-300'; break;
        default: return null;
      }
      const subtextColor = {
        [MessageType.Success]: 'text-green-400',
        [MessageType.Error]: 'text-red-400',
        [MessageType.Warning]: 'text-orange-400',
      }[type] || 'text-gray-400';

      return (
        <div className={`${baseClasses} ${typeClasses}`} role="alert">
          <p>{text}</p>
          {subtext && <p className={`${subtextColor} font-semibold mt-1 text-xs`}>{subtext}</p>}
        </div>
      );
    };

    const getHealthColor = (percentage) => {
        if (percentage <= 15) return 'text-green-400';
        if (percentage < 30) return 'text-yellow-400';
        return 'text-red-400';
    };
    const getHealthBarColor = (percentage) => {
        if (percentage <= 15) return 'bg-green-500';
        if (percentage < 30) return 'bg-yellow-500';
        return 'bg-red-500';
    };

    const DuplicateHealth = ({ data, isLoading, title, subtitle }) => {
      if (isLoading) {
        return (
          <div className="bg-gray-800 p-3 rounded-lg animate-pulse">
            <div className="h-4 bg-gray-700 rounded w-3/4 mb-2"></div>
            <div className="h-8 bg-gray-700 rounded w-1/4 mb-3"></div>
            <div className="h-2 bg-gray-700 rounded"></div>
          </div>
        );
      }

      if (!data) {
        return <div className="bg-gray-800 p-3 rounded-lg text-center text-gray-400">No health data available.</div>;
      }

      const { percentage } = data;
      const colorClass = getHealthColor(percentage);
      const barColorClass = getHealthBarColor(percentage);
      
      return (
        <div className="bg-gray-800 p-3 rounded-lg border border-gray-700">
          <h2 className="text-lg font-semibold text-gray-200 mb-1">{title}</h2>
          <p className="text-xs text-gray-400 mb-2">{subtitle}</p>
          <div className="flex items-center gap-4">
            <p className={`text-4xl font-bold ${colorClass}`}>{percentage}%</p>
            <div className="w-full">
                <div className="flex justify-between text-xs text-gray-400 mb-1">
                    <span>{data.totalDuplicates} Duplicates</span>
                    <span>{data.totalChecked} Total</span>
                </div>
                <div className="w-full bg-gray-700 rounded-full h-2.5">
                    <div className={`${barColorClass} h-2.5 rounded-full transition-all duration-500 ease-out`} style={{ width: `${percentage}%` }}></div>
                </div>
            </div>
          </div>
        </div>
      );
    };

    const AddRecordForm = ({ onSubmit, isSubmitting }) => {
      const [firstName, setFirstName] = useState('');
      const [lastName, setLastName] = useState('');
      const [dob, setDob] = useState('');

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (isSubmitting || !firstName || !lastName || !dob) return;
        await onSubmit({ firstName, lastName, dob });
        setFirstName('');
        setLastName('');
        setDob('');
      };

      return (
        <form onSubmit={handleSubmit} className="space-y-3">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label htmlFor="firstName" className="block text-sm font-medium text-gray-300 mb-1">First Name</label>
              <input type="text" id="firstName" value={firstName} onChange={(e) => setFirstName(e.target.value)} required className="w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm py-1.5 px-3 text-gray-100 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500" />
            </div>
            <div>
              <label htmlFor="lastName" className="block text-sm font-medium text-gray-300 mb-1">Last Name</label>
              <input type="text" id="lastName" value={lastName} onChange={(e) => setLastName(e.target.value)} required className="w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm py-1.5 px-3 text-gray-100 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500" />
            </div>
          </div>
          <div>
            <label htmlFor="dob" className="block text-sm font-medium text-gray-300 mb-1">Date of Birth</label>
            <input type="date" id="dob" value={dob} onChange={(e) => setDob(e.target.value)} required className="w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm py-1.5 px-3 text-gray-100 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500" />
          </div>
          <button type="submit" disabled={isSubmitting} className="w-full flex justify-center items-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-cyan-600 hover:bg-cyan-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-cyan-500 disabled:bg-gray-500 disabled:cursor-not-allowed transition-colors">
            {isSubmitting ? <Spinner /> : 'Add & Check Record'}
          </button>
        </form>
      );
    };

    // --- CONTEXT-SPECIFIC VIEWS ---
    const SheetIcon = () => (
        <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 text-gray-400 group-hover:text-cyan-400 transition-colors" viewBox="0 0 20 20" fill="currentColor">
            <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
            <path fillRule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clipRule="evenodd" />
        </svg>
    );

    const GeminiIcon = () => (
        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12.5 5.515c1.334-2.134 4.133-2.68 6.267-.985c2.134 1.694 2.68 4.827.985 6.961l-7.252 8.016l-7.252-8.016c-1.695-2.134-.94-5.267 1.194-6.961c2.134-1.695 4.933-.94 6.267.985Z"/>
        </svg>
    );

    const GeminiHealthCard = ({ stats, isLoadingStats }) => {
        const [summary, setSummary] = useState('');
        const [isLoadingSummary, setIsLoadingSummary] = useState(false);
        const [error, setError] = useState('');

        const handleGenerateSummary = useCallback(async () => {
            if (!stats || stats.length === 0) {
                setError('There is no data to analyze for the selected period.');
                return;
            }
            setIsLoadingSummary(true);
            setError('');
            setSummary('');
            try {
                const result = await server.run('getGeminiHealthSummary', stats);
                setSummary(result);
            } catch (err) {
                setError(err.message || 'Failed to generate summary.');
            } finally {
                setIsLoadingSummary(false);
            }
        }, [stats]);

        return (
            <div className="bg-gray-800 border border-gray-700 rounded-lg p-3 space-y-2">
                <div className="flex items-center justify-between">
                    <h3 className="text-md font-semibold text-gray-200 flex items-center gap-2">
                        <GeminiIcon />
                        AI Health Summary
                    </h3>
                    <button
                        onClick={handleGenerateSummary}
                        disabled={isLoadingStats || isLoadingSummary}
                        className="flex items-center gap-1.5 px-2.5 py-1 text-xs font-semibold text-white bg-gradient-to-r from-cyan-600 to-blue-600 rounded-md hover:opacity-90 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        {isLoadingSummary ? <Spinner /> : 'Generate Analysis'}
                    </button>
                </div>
                {error && <Message text={error} type={MessageType.Error} />}
                {summary && (
                    <div className="bg-gray-900/50 p-2.5 rounded-md border-l-4 border-cyan-500">
                        <p className="text-sm text-gray-300 italic">{summary}</p>
                    </div>
                )}
            </div>
        );
    };

    const AdminDashboard = () => {
        const [stats, setStats] = useState([]);
        const [isLoading, setIsLoading] = useState(true);

        const getMonday = (d) => {
            d = new Date(d);
            const day = d.getDay(),
                diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        };

        const [startDate, setStartDate] = useState(getMonday(new Date()));
        const [endDate, setEndDate] = useState(new Date());
        const [activeFilter, setActiveFilter] = useState('WTD');

        const dateToInputValue = (date) => date ? date.toISOString().split('T')[0] : '';

        const fetchData = useCallback(async (start, end) => {
            setIsLoading(true);
            try {
                const startDateStr = start ? dateToInputValue(start) : null;
                const endDateStr = end ? dateToInputValue(end) : null;
                const data = await server.run('getAdminDashboardData', startDateStr, endDateStr);
                setStats(data.sort((a, b) => b.percentage - a.percentage));
            } catch (error) {
                console.error('Failed to load admin data:', error);
            } finally {
                setIsLoading(false);
            }
        }, []);

        useEffect(() => {
            fetchData(startDate, endDate);
        }, [startDate, endDate, fetchData]);
        
        const setDateRange = (filter) => {
            const today = new Date();
            let newStart = new Date();
            let newEnd = new Date(today);

            if (filter === 'WTD') {
                newStart = getMonday(today);
            } else if (filter === 'MTD') {
                newStart = new Date(today.getFullYear(), today.getMonth(), 1);
            } else if (filter === 'YTD') {
                newStart = new Date(today.getFullYear(), 0, 1);
            } else if (filter === 'ALL') {
                newStart = null;
                newEnd = null;
            }
            setActiveFilter(filter);
            setStartDate(newStart);
            setEndDate(newEnd);
        };
        
        const subtitle = useMemo(() => {
            if (activeFilter === 'ALL') return 'Duplicate percentages for all records.';
            if (startDate && endDate) {
              const options = { year: 'numeric', month: 'short', day: 'numeric' };
              return `${startDate.toLocaleDateString(undefined, options)} - ${endDate.toLocaleDateString(undefined, options)}`;
            }
            return 'Duplicate percentages for the selected period.'
        }, [startDate, endDate, activeFilter]);

        const renderContent = () => {
             if (isLoading) {
                return (
                    <div className="space-y-2 mt-4">
                        {[...Array(3)].map((_, i) => (
                            <div key={i} className="bg-gray-800 p-2 rounded-lg animate-pulse">
                                <div className="h-4 bg-gray-700 rounded w-1/2 mb-3"></div>
                                <div className="h-2 bg-gray-700 rounded"></div>
                            </div>
                        ))}
                    </div>
                );
            }
            if (stats.length === 0) {
                return <p className="text-gray-400 text-center py-8">No data to display for this period.</p>;
            }
            return (
                <div className="space-y-2 max-h-72 overflow-y-auto pr-1 mt-2">
                {stats.map(stat => (
                    <div key={stat.sourceId} className="bg-gray-800 p-2 rounded-lg border border-gray-700">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <a href={`https://docs.google.com/spreadsheets/d/${stat.sourceId}/edit`} target="_blank" rel="noopener noreferrer" className="group" title="Open Sheet">
                                    <SheetIcon />
                                </a>
                                <p className="text-sm font-medium text-gray-300 truncate" title={stat.sourceName}>{stat.sourceName}</p>
                            </div>
                            <div className="text-right text-xs text-gray-500">
                                {stat.totalDuplicates} / {stat.totalChecked}
                            </div>
                        </div>
                        <div className="flex items-center gap-2 mt-1.5">
                            <p className={`text-lg font-bold w-12 text-right ${getHealthColor(stat.percentage)}`}>{stat.percentage}%</p>
                            <div className="w-full bg-gray-700 rounded-full h-1.5">
                                <div className={`${getHealthBarColor(stat.percentage)} h-1.5 rounded-full`} style={{ width: `${stat.percentage}%` }}></div>
                            </div>
                        </div>
                    </div>
                ))}
                </div>
            );
        };

        const FilterButton = ({ label, filter }) => {
          const isActive = activeFilter === filter;
          return (
            <button
              onClick={() => setDateRange(filter)}
              className={`px-2 py-0.5 text-xs rounded-full transition-colors ${
                isActive
                  ? 'bg-cyan-600 text-white font-semibold'
                  : 'bg-gray-600 text-gray-300 hover:bg-gray-500'
              }`}
            >
              {label}
            </button>
          );
        };

        return (
            <div className="space-y-3">
                <h2 className="text-lg font-semibold text-gray-200">Source Duplication Stats</h2>
                <p className="text-xs text-gray-400 -mt-2">{subtitle}</p>

                <GeminiHealthCard stats={stats} isLoadingStats={isLoading} />
                
                <div className="bg-gray-800 border border-gray-700 p-2 rounded-lg space-y-2">
                    <div className="grid grid-cols-2 gap-2">
                        <input type="date" value={dateToInputValue(startDate)} onChange={(e) => { setStartDate(new Date(e.target.value+'T00:00:00')); setActiveFilter('');}} className="w-full text-xs bg-gray-700 border border-gray-600 rounded py-1 px-2 text-gray-200 focus:outline-none focus:ring-1 focus:ring-cyan-500" />
                        <input type="date" value={dateToInputValue(endDate)} onChange={(e) => { setEndDate(new Date(e.target.value+'T00:00:00')); setActiveFilter('');}} className="w-full text-xs bg-gray-700 border border-gray-600 rounded py-1 px-2 text-gray-200 focus:outline-none focus:ring-1 focus:ring-cyan-500" />
                    </div>
                    <div className="flex justify-center items-center gap-2 pt-1">
                        <FilterButton label="WTD" filter="WTD" />
                        <FilterButton label="MTD" filter="MTD" />
                        <FilterButton label="YTD" filter="YTD" />
                        <FilterButton label="ALL" filter="ALL" />
                    </div>
                </div>

                {renderContent()}
            </div>
        );
    };

    const SourceSheetView = ({ contextData }) => {
        const [healthData, setHealthData] = useState(null);
        const [isLoadingHealth, setIsLoadingHealth] = useState(true);
        const [isSubmitting, setIsSubmitting] = useState(false);
        const [message, setMessage] = useState({ text: '', subtext: '', type: MessageType.None });

        const fetchHealthData = useCallback(async () => {
            setIsLoadingHealth(true);
            try {
                const data = await server.run('getSourceSheetHealthData', contextData.sourceId);
                setHealthData(data);
            } catch (error) {
                setMessage({ text: 'Failed to load health data.', type: MessageType.Error });
            } finally {
                setIsLoadingHealth(false);
            }
        }, [contextData.sourceId]);

        useEffect(() => {
            fetchHealthData();
        }, [fetchHealthData]);

        useEffect(() => {
            if (message.text) {
                const timer = setTimeout(() => setMessage({ text: '', type: MessageType.None }), 5000);
                return () => clearTimeout(timer);
            }
        }, [message]);

        const handleAddRecord = async (formData) => {
            setIsSubmitting(true);
            setMessage({ text: '', type: MessageType.None });
            try {
                const response = await server.run('addRecordToSourceSheet', formData);
                if (response.success) {
                    setMessage({ text: response.message, type: MessageType.Success });
                } else {
                    setMessage({ text: response.message, type: MessageType.Error });
                }
            } catch (error) {
                setMessage({ text: error.message || 'An unexpected error occurred.', type: MessageType.Error });
            } finally {
                setIsSubmitting(false);
            }
        };

        return (
            <div className="space-y-4">
                <DuplicateHealth 
                    data={healthData} 
                    isLoading={isLoadingHealth} 
                    title={contextData.sourceName}
                    subtitle="Duplicate stats for this source (current week)."
                />
                <div className="h-10 flex items-center justify-center">
                    {message.text && <Message text={message.text} type={message.type} />}
                </div>
                <AddRecordForm onSubmit={handleAddRecord} isSubmitting={isSubmitting} />
            </div>
        );
    };
    
    const DefaultView = () => {
        const [healthData, setHealthData] = useState(null);
        const [isLoadingHealth, setIsLoadingHealth] = useState(true);
        const [isSubmitting, setIsSubmitting] = useState(false);
        const [message, setMessage] = useState({ text: '', subtext: '', type: MessageType.None });

        const fetchHealthData = useCallback(async () => {
            setIsLoadingHealth(true);
            try {
                const data = await server.run('getDuplicateHealthData');
                setHealthData(data);
            } catch (error) {
                setMessage({ text: 'Failed to load health data.', type: MessageType.Error });
            } finally {
                setIsLoadingHealth(false);
            }
        }, []);

        useEffect(() => { fetchHealthData(); }, [fetchHealthData]);

        useEffect(() => {
            if (message.text) {
                const timer = setTimeout(() => setMessage({ text: '', type: MessageType.None }), 7000);
                return () => clearTimeout(timer);
            }
        }, [message]);

        const handleAddRecord = async (formData) => {
            setIsSubmitting(true);
            setMessage({ text: '', type: MessageType.None });
            try {
                const response = await server.run('addRecordAndCheckDuplicates', formData);
                if (response.success) {
                    setMessage({ text: response.message, type: MessageType.Success });
                    fetchHealthData();
                } else {
                    if (response.duplicatesFound > 0) {
                        setMessage({ text: response.message, subtext: 'Please check Master sheet for details.', type: MessageType.Warning });
                        fetchHealthData();
                    } else {
                        setMessage({ text: response.message, type: MessageType.Error });
                    }
                }
            } catch (error) {
                setMessage({ text: error.message || 'An unexpected error occurred.', type: MessageType.Error });
            } finally {
                setIsSubmitting(false);
            }
        };

        return (
            <div className="space-y-4">
              <DuplicateHealth 
                data={healthData} 
                isLoading={isLoadingHealth}
                title="Overall Duplicate Health"
                subtitle="Percentage of duplicates since previous Monday."
              />
              <div className="h-10 flex items-center justify-center">
                 {message.text && <Message text={message.text} subtext={message.subtext} type={message.type} />}
              </div>
              <AddRecordForm onSubmit={handleAddRecord} isSubmitting={isSubmitting} />
            </div>
        );
    };

    // --- MAIN APP COMPONENT (CONTEXT ROUTER) ---

    const App = () => {
        const [context, setContext] = useState({ type: 'LOADING' });

        useEffect(() => {
            const determineContext = async () => {
                try {
                    const contextData = await server.run('getContext');
                    setContext({ type: contextData.context, data: contextData });
                } catch (error) {
                    console.error("Failed to get context", error);
                    setContext({ type: 'ERROR', data: { message: 'Could not connect to the backend.' } });
                }
            };
            determineContext();
        }, []);

        const renderContent = () => {
            switch (context.type) {
                case 'LOADING':
                    return <div className="p-8 text-center flex justify-center"><Spinner /></div>;
                case 'MASTER':
                    return <AdminDashboard />;
                case 'SOURCE':
                    return <SourceSheetView contextData={context.data} />;
                case 'OTHER':
                    return <DefaultView />;
                case 'OTHER_NO_HEADERS':
                    return <Message 
                        text="This sheet is not configured for data entry." 
                        subtext="Please ensure it has 'FIRST NAME', 'LAST NAME', and 'DOB' columns."
                        type={MessageType.Warning} 
                    />;
                case 'ERROR':
                    return <Message text={context.data.message} type={MessageType.Error} />;
                default:
                    return <Message text="Unknown application context." type={MessageType.Error} />;
            }
        };
        
        const headerTitle = useMemo(() => {
          switch (context.type) {
            case 'MASTER': return "Admin Dashboard";
            case 'SOURCE': return context.data.sourceName || "Source DeDuper";
            default: return "BHG DeDuper";
          }
        }, [context]);

        return (
            <div className="min-h-screen bg-gray-800 text-gray-100 p-2 font-sans">
                <div className="max-w-md mx-auto bg-gray-900 shadow-2xl rounded-lg overflow-hidden">
                    <header className="p-4 bg-gray-700 border-b border-gray-600">
                        <h1 className="text-xl font-bold text-center text-cyan-400 truncate" title={headerTitle}>
                          {headerTitle}
                        </h1>
                    </header>
                    <main className="p-4">
                        {renderContent()}
                    </main>
                </div>
            </div>
        );
    };

    // --- RENDER THE APP ---
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

  </script>
</body>
</html>
